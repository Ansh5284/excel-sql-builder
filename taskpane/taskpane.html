<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Excel SQL Builder</title>

    <!-- Office JS -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    
    <!-- Third Party Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/alasql@4.0.0/dist/alasql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Styles -->
    <link href="taskpane.css" rel="stylesheet" type="text/css" />
</head>
<body class="ms-font-m">

    <div class="container">
        <!-- Header & Toolbar -->
        <div class="header-row">
            <h2>SQL Query Builder</h2>
            <div style="display:flex; gap:5px;">
                <!-- NEW BUTTON FOR STAGE 3 -->
                <button id="btn-open-advanced" class="small-btn" style="background:#eff6fc; color:#0078d4; border-color:#0078d4;">ðŸš€ Advanced</button>
                <button id="btn-reset" class="small-btn danger-btn">Reset</button>
            </div>
        </div>
        
        <!-- Data Source Info -->
        <div class="section">
            <div class="ms-font-s-plus" id="current-table">Select a range...</div>
            <div id="source-list" class="list-container source-container">
                <!-- Draggable Items appear here -->
            </div>
        </div>

        <div class="divider"></div>

        <!-- 1. SELECT -->
        <div class="section">
            <label style="margin:0; margin-bottom:8px;">SELECT Columns <input type="checkbox" id="chk-distinct" style="margin-left:5px;"> Distinct</label>
            <div id="select-list" class="list-container drop-zone">
                <div class="placeholder">Drop columns here...</div>
            </div>
        </div>

        <!-- 2. WHERE -->
        <div class="section">
            <label>WHERE (Filter)</label>
            <div id="where-list" class="list-container drop-zone">
                <div class="placeholder">Drop columns to filter...</div>
            </div>
        </div>

        <!-- 3. GROUP BY -->
        <div class="section">
            <label>GROUP BY</label>
            <div id="groupby-list" class="list-container drop-zone">
                <div class="placeholder">Drop columns to group...</div>
            </div>
        </div>

        <!-- 4. HAVING -->
        <div class="section">
            <label>HAVING (Filter Groups)</label>
            <div id="having-list" class="list-container drop-zone">
                <div class="placeholder">Drop columns to filter groups...</div>
            </div>
        </div>

        <!-- 5. ORDER BY -->
        <div class="section">
            <label>ORDER BY</label>
            <div id="orderby-list" class="list-container drop-zone">
                <div class="placeholder">Drop columns to sort...</div>
            </div>
        </div>

        <!-- 6. CONTROLS -->
        <div class="section controls">
            <div class="control-row">
                <label>Limit:</label>
                <input type="number" id="txt-limit" placeholder="All" style="width: 60px;">
            </div>
            
            <div class="control-row">
                <label>Output Cell:</label>
                <input type="text" id="txt-output" placeholder="New Sheet" readonly>
                <button id="btn-set-output" class="ms-Button ms-Button--primary">Set</button>
            </div>
        </div>

        <!-- 7. SQL PREVIEW -->
        <div class="section">
            <label style="margin-bottom: 5px;">Live SQL Preview:</label>
            <textarea id="sql-preview" readonly class="sql-box"></textarea>
        </div>

        <!-- 8. ACTIONS -->
        <div class="footer">
            <button id="run-btn" class="action-btn">RUN QUERY</button>
        </div>
    </div>

    <!-- MODAL: ADD VIRTUAL COLUMN -->
    <div id="modal-add-col" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Add Calculated Column</h3>
                <span class="close-modal-btn" id="btn-close-x">âœ–</span>
            </div>
            
            <!-- Shared Inputs -->
            <div class="modal-row">
                <label>Name:</label>
                <input type="text" id="new-col-name" placeholder="Column Name">
            </div>

            <!-- Chips Container (ALWAYS VISIBLE for clicking) -->
            <div class="modal-chips-area">
                <label style="font-size:11px; color:#666;">Available Columns (Click to Insert):</label>
                <div id="modal-chip-list" class="source-container small-chips">
                    <!-- Cloned chips will go here -->
                </div>
            </div>
            
            <!-- TABS -->
            <div class="modal-tabs">
                <div class="tab active" id="tab-btn-formula" onclick="switchModalTab('formula')">Standard Formula</div>
                <div class="tab" id="tab-btn-cond" onclick="switchModalTab('cond')">Conditional (IF/ELSE)</div>
            </div>

            <div class="modal-body-scroll">
                <!-- TAB 1: FORMULA -->
                <div id="view-formula" class="tab-view">
                    <textarea id="new-col-formula" class="formula-def" placeholder="e.g. [Price] * [Qty]"></textarea>
                </div>

                <!-- TAB 2: CONDITIONAL -->
                <div id="view-cond" class="tab-view" style="display:none;">
                    <div id="cond-rows-container">
                        <!-- Dynamic Rows go here -->
                    </div>
                    <button id="btn-add-rule" class="small-btn dashed-btn">+ Add Rule</button>
                    
                    <div class="cond-else-row">
                        <span style="font-weight:bold; font-size:11px;">ELSE</span>
                        <input type="text" id="cond-else" placeholder="Default Result">
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="btn-cancel-col" class="small-btn">Cancel</button>
                <button id="btn-save-col" class="action-btn" style="width:auto; padding: 6px 12px;">Save Column</button>
            </div>
        </div>
    </div>

    <!-- Hidden Helpers -->
    <input type="date" id="date-helper" style="display:none; position:absolute;">

    <!-- Logic -->
    <script src="taskpane.js" type="text/javascript"></script>
</body>
</html>