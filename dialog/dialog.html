<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SQL Advanced Editor</title>

    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <link href="dialog.css" rel="stylesheet" type="text/css" />
</head>
<body>

    <div class="header">
        <div class="logo">üç≥ SQL Workbench</div>
        <div class="tabs">
            <div class="tab active" id="tab-visual" onclick="switchTab('visual')">Visual Joiner</div>
            <div class="tab" id="tab-sql" onclick="switchTab('sql')">Raw SQL</div>
        </div>
    </div>

    <div class="workspace">
        <div class="sidebar">
            <div class="sidebar-actions">
                <button class="btn-icon" id="btn-add-table"><span>üìÖ</span> Add Table</button>
                <button class="btn-icon" id="btn-add-calc"><span>∆íx</span> Add Calc</button>
                <div style="flex-basis: 100%; height: 5px;"></div> <!-- Spacer -->
                <button class="btn-icon btn-special" id="btn-save-view-cte"><span>‚ö°</span> Save View as CTE</button>
                <button class="btn-icon btn-union" id="btn-create-union"><span>üîó</span> Create Union</button>
            </div>
            <div class="tree-view" id="ingredients-list">
                <div class="placeholder-text">Loading Schema...</div>
            </div>
        </div>

        <div class="main-area">
            <!-- VIEW 1: VISUAL JOINER -->
            <div id="view-visual" class="canvas-view" style="display:flex;">
                <div class="canvas-bg" id="visual-drop-zone">
                    <!-- SVG LAYER FOR LINES -->
                    <svg id="connections-layer"></svg>
                    
                    <div class="empty-state">Drag Tables here, connect them, then click "Save View as CTE" to build logic steps.</div>
                </div>
            </div>

            <!-- VIEW 2: SQL EDITOR -->
            <div id="view-sql" class="canvas-view" style="display:none; flex-direction:column;">
                <div class="editor-toolbar">
                    <button class="editor-btn">Format SQL</button>
                    <button class="editor-btn">Clear</button>
                </div>
                <textarea id="sql-editor-area" class="sql-area" placeholder="-- SQL will generate automatically..."></textarea>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="btn btn-cancel" id="btn-close">Cancel</button>
        <button class="btn btn-primary" id="btn-apply">Run & Load to Excel</button>
    </div>

    <!-- JOIN EDITOR BUBBLE (Floating) -->
    <div id="join-editor" class="join-popover" style="display:none;">
        <div class="join-header">Edit Relationship</div>
        <div class="join-body">
            <select id="join-type-select">
                <option value="INNER JOIN">INNER JOIN</option>
                <option value="LEFT JOIN">LEFT JOIN</option>
                <option value="RIGHT JOIN">RIGHT JOIN</option>
                <option value="FULL OUTER JOIN">FULL JOIN</option>
            </select>
            <div class="join-equation">
                <span id="join-left-col">Col A</span>
                <select id="join-op-select">
                    <option value="=">=</option>
                    <option value=">">></option>
                    <option value="<"><</option>
                    <option value=">=">>=</option>
                    <option value="<="><=</option>
                    <option value="<>"><></option>
                </select>
                <span id="join-right-col">Col B</span>
            </div>
        </div>
        <div class="join-footer">
            <button class="btn-xs btn-danger" id="btn-delete-join">Delete Line</button>
            <button class="btn-xs btn-primary" id="btn-save-join">Update</button>
        </div>
    </div>

    <!-- MODAL: ADD VIRTUAL COLUMN -->
    <div id="modal-add-col" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Add Calculated Column</h3>
                <span class="close-modal-btn" id="btn-close-x">‚úñ</span>
            </div>
            <div class="modal-row">
                <label>Name:</label>
                <input type="text" id="new-col-name" placeholder="Column Name">
            </div>
            <div class="modal-chips-area">
                <label style="font-size:11px; color:#666;">Available Columns (Click to Insert):</label>
                <div id="modal-chip-list" class="source-container small-chips"></div>
            </div>
            <div class="modal-tabs">
                <div class="tab active" id="tab-btn-formula" onclick="switchModalTab('formula')">Standard Formula</div>
                <div class="tab" id="tab-btn-cond" onclick="switchModalTab('cond')">Conditional (IF/ELSE)</div>
            </div>
            <div class="modal-body-scroll">
                <div id="view-formula" class="tab-view">
                    <textarea id="new-col-formula" class="formula-def" placeholder="e.g. [Price] * [Qty]"></textarea>
                </div>
                <div id="view-cond" class="tab-view" style="display:none;">
                    <div id="cond-rows-container"></div>
                    <button id="btn-add-rule" class="small-btn dashed-btn">+ Add Rule</button>
                    <div class="cond-else-row">
                        <span style="font-weight:bold; font-size:11px;">ELSE</span>
                        <input type="text" id="cond-else" placeholder="Default Result">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btn-cancel-col" class="small-btn">Cancel</button>
                <button id="btn-save-col" class="action-btn" style="width:auto; padding: 6px 12px;">Save Column</button>
            </div>
        </div>
    </div>

    <!-- MODAL: NAME CTE -->
    <div id="modal-name-cte" class="modal-overlay" style="display:none;">
        <div class="modal-card" style="height: auto; max-width: 350px;">
            <div class="modal-header">
                <h3>Save View as CTE</h3>
                <span class="close-modal-btn" id="btn-close-cte-name">‚úñ</span>
            </div>
            <div class="modal-body-scroll">
                <div style="padding:15px; display:flex; flex-direction:column; gap:10px;">
                    <div>
                        <label style="font-weight:bold; font-size:12px;">CTE Name</label>
                        <input type="text" id="input-cte-name" placeholder="e.g. SalesSummary" style="width:100%;">
                        <div style="font-size:11px; color:#666; margin-top:5px;">
                            This will save the current canvas as a reusable table. The canvas will be cleared.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btn-confirm-save-cte" class="action-btn" style="width:100%;">Save & Clear Canvas</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIRMATION -->
    <div id="modal-confirm" class="modal-overlay" style="display:none;">
        <div class="modal-card" style="height: auto; max-width: 350px;">
            <div class="modal-header">
                <h3 id="confirm-title">Confirm</h3>
                <span class="close-modal-btn" id="btn-close-confirm">‚úñ</span>
            </div>
            <div class="modal-body-scroll">
                <div style="padding:15px;" id="confirm-message">
                    Are you sure?
                </div>
            </div>
            <div class="modal-actions">
                <button class="small-btn" id="btn-cancel-confirm">Cancel</button>
                <button id="btn-confirm-yes" class="action-btn" style="width:auto;">Yes</button>
            </div>
        </div>
    </div>

    <!-- MODAL: UNION BUILDER (NEW) -->
    <div id="modal-union-builder" class="modal-overlay" style="display:none;">
        <div class="modal-card" style="width: 800px; max-width: 95vw; height: 700px;">
            <div class="modal-header">
                <h3>Create Union (CTE Generator)</h3>
                <span class="close-modal-btn" id="btn-close-union">‚úñ</span>
            </div>
            <div class="modal-body" style="display:flex; flex:1; overflow:hidden;">
                <!-- Sidebar -->
                <div class="union-sidebar">
                    <div class="sidebar-title">Available Tables</div>
                    <div id="union-source-list" class="union-source-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Config -->
                <div class="union-config-area">
                    <!-- Step 1 -->
                    <div class="step-box">
                        <div class="step-label"><span class="step-number">1</span> Master Table (Defines Output)</div>
                        <select id="union-master-select">
                            <option value="" disabled selected>Select a primary table...</option>
                        </select>
                        <div id="union-master-cols" style="margin-top:5px; font-size:11px; color:#666;"></div>
                    </div>

                    <!-- Step 2 -->
                    <div class="step-box" id="union-step-mapping" style="display:none;">
                        <div class="step-label">
                            <span class="step-number">2</span> Column Mapping
                            <div style="margin-left:auto; font-weight:normal; font-size:12px;">
                                <label><input type="radio" name="u_type" value="UNION ALL" checked> Union All</label>
                                <label style="margin-left:10px;"><input type="radio" name="u_type" value="UNION"> Union (Distinct)</label>
                            </div>
                        </div>
                        <div id="union-mapping-container"></div>
                    </div>
                    
                    <!-- Step 3 Name -->
                     <div class="step-box" id="union-step-name" style="display:none;">
                        <div class="step-label"><span class="step-number">3</span> Name Result</div>
                        <input type="text" id="union-result-name" placeholder="e.g. All_Sales_Data" style="width:100%;">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="btn-cancel-union" class="small-btn">Cancel</button>
                <button id="btn-save-union" class="action-btn">Save as Union CTE</button>
            </div>
        </div>
    </div>
<script src="taskpane.js" type="text/javascript"></script>
</body>
</html>


