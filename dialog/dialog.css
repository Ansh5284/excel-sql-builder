:root {
    --brand: #0078d4;
    --brand-light: #eff6fc;
    --bg: #f3f2f1;
    --white: #ffffff;
    --border: #e1dfdd;
    --text: #323130;
    --code-bg: #1e1e1e;
    --error-red: #a80000;
}

body { margin: 0; font-family: "Segoe UI", sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
* { box-sizing: border-box; }

/* HEADER & TABS */
.header { background: var(--white); padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0; }
.logo { font-size: 16px; font-weight: bold; color: var(--brand); }
.tabs { display: flex; height: 100%; }
.tab { padding: 0 20px; cursor: pointer; display: flex; align-items: center; font-size: 13px; font-weight: 500; color: #666; border-bottom: 3px solid transparent; }
.tab:hover { background: #f9f9f9; }
.tab.active { border-bottom-color: var(--brand); color: var(--brand); font-weight: bold; }

/* MAIN LAYOUT */
.workspace { flex: 1; display: flex; overflow: hidden; }
.sidebar { width: 250px; background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
.sidebar-actions { padding: 10px; border-bottom: 1px solid var(--border); display: flex; gap: 5px; flex-wrap: wrap; }
.main-area { flex: 1; display: flex; position: relative; overflow: hidden; }
.canvas-view { flex: 1; width: 100%; height: 100%; }

/* VISUAL CANVAS */
.canvas-bg { 
    flex: 1; 
    background-image: radial-gradient(#ccc 1px, transparent 1px); 
    background-size: 20px 20px; 
    position: relative; 
    overflow: auto; /* Scrollable */
    width: 100%; 
    height: 100%;
}

/* SVG LAYER */
#connections-layer {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none; /* Click through to tables */
    z-index: 0; /* Behind tables */
    min-width: 100%; min-height: 100%; /* Grow with scroll */
}
/* The line paths */
.join-path {
    stroke: #999;
    stroke-width: 3px;
    fill: none;
    cursor: pointer;
    pointer-events: stroke; /* Allow clicking the line itself */
    transition: stroke 0.2s;
}
.join-path:hover { stroke: var(--brand); stroke-width: 5px; }
.join-path.selected { stroke: var(--brand); stroke-width: 5px; }

/* TABLE CARDS */
.table-card { 
    position: absolute; /* Freely movable via drag/drop (simplified to relative for now or we add drag logic) */
    width: 200px; 
    background: var(--white); 
    border: 1px solid #ccc; 
    border-radius: 6px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    display: flex; flex-direction: column; 
    z-index: 1; 
    margin: 20px; /* Initial spacing */
}
/* If we want true free dragging, we need more JS. For V3, let's use flexbox flow but maybe simple absolute? 
   Let's stick to flex flow for simplicity, but lines need recalculation.
   Actually, Flex is safer for "toddler book" style: Left and Right columns.
   Let's keep the existing flow but fix positioning. 
   Actually, absolute positioning is better for lines. I'll use a grid layout in JS.
*/

.card-header { background: var(--brand); color: white; padding: 8px 10px; font-weight: bold; border-radius: 5px 5px 0 0; display: flex; justify-content: space-between; align-items: center; font-size: 12px; cursor: grab; }
.card-body { padding: 0; max-height: 300px; overflow-y: auto; background: white; }
.col-item { padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 12px; cursor: pointer; display: flex; justify-content: space-between; position: relative; }
.col-item:hover { background: #f3f2f1; }
/* Dot for connection anchor */
.col-anchor { width: 8px; height: 8px; background: #bbb; border-radius: 50%; margin-top: 4px; display: none; }
.col-item:hover .col-anchor { display: block; background: var(--brand); }

/* JOIN POPOVER */
.join-popover {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border-radius: 6px;
    width: 260px;
    z-index: 100;
    font-size: 12px;
    padding: 0;
    animation: popIn 0.1s ease-out;
}
.join-header { background: #f3f2f1; padding: 8px 12px; font-weight: bold; border-bottom: 1px solid #eee; border-radius: 6px 6px 0 0; }
.join-body { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
.join-equation { display: flex; align-items: center; gap: 5px; justify-content: space-between; background: #faf9f8; padding: 5px; border-radius: 4px; border: 1px solid #eee; }
.join-footer { padding: 8px 12px; border-top: 1px solid #eee; display: flex; justify-content: space-between; }

/* Buttons & Inputs */
.btn-icon { background: var(--brand-light); color: var(--brand); border: 1px solid transparent; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px; }
.btn-icon:hover { background: #deecf9; border-color: var(--brand); }
.btn-xs { padding: 4px 8px; border-radius: 3px; border: none; cursor: pointer; font-size: 11px; font-weight: 600; }
.btn-danger { background: #fde7e9; color: #a80000; border: 1px solid #fde7e9; }
.btn-danger:hover { background: #a80000; color: white; }
.btn-primary { background: var(--brand); color: white; }

select { padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; }

/* Chips, Trees, etc (Kept from before) */
.chip { display: flex; background: var(--white); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 3px; cursor: grab; user-select: none; }
.chip-icon { background: #f8f8f8; padding: 2px 6px; border-right: 1px solid #eee; font-size: 10px; display: flex; align-items: center; width: 30px; justify-content: center; font-family: monospace; }
.chip-name { padding: 2px 8px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;}
.type-num { color: #0078d4; }
.type-txt { color: #d13438; }
.type-date { color: #107c10; }
.type-calc { color: #813a7c; background-color: #fcf0fa !important; }

/* MODAL styles (Minified for brevity, assume same as before) */
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
.modal-card { background: white; width: 95%; max-width: 450px; height: 80vh; border-radius: 4px; display: flex; flex-direction: column; }
.modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.close-modal-btn { cursor: pointer; }
.modal-row, .modal-chips-area, .modal-tabs, .modal-actions { padding: 10px 20px; }
.modal-body-scroll { flex: 1; overflow-y: auto; padding: 20px; }
.source-container.small-chips { display: flex; flex-wrap: wrap; gap: 4px; }
.formula-def { width: 100%; height: 80px; }
.cond-row { display: flex; gap: 5px; margin-bottom: 5px; }
.cond-input-col { flex: 1; }